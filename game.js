/****
* Assets
****/
LK.init.image('DJ', {width:100, height:66.02, id:'684b3ed3823cf46e816a07fb'})
LK.init.image('arrowtap', {width:100, height:100, id:'684b4b8a823cf46e816a08b7'})
LK.init.image('beatMarker', {width:60, height:59.77, id:'684c0ee299bba813a7965a7a'})
LK.init.image('blurred', {width:1200, height:1075, id:'684bf67499bba813a7965982'})
LK.init.image('closebutton', {width:100, height:51.95, id:'684c176d99bba813a7965aec'})
LK.init.image('creditsbg', {width:2048, height:2732, id:'684b396e823cf46e816a079f'})
LK.init.image('creditsbutton', {width:100, height:54.3, id:'684b3c4e823cf46e816a07df'})
LK.init.image('creditstab', {width:150, height:172.97, id:'684b617d823cf46e816a097b'})
LK.init.image('defeatbg', {width:2048, height:2048, id:'684b6eb8823cf46e816a0a20'})
LK.init.image('gameover', {width:100, height:67.19, id:'684b6dba823cf46e816a0a0e'})
LK.init.image('goodCircle', {width:180, height:177, id:'684b43f8823cf46e816a0841'})
LK.init.image('heart', {width:140, height:127.96, id:'684b5a01823cf46e816a092d'})
LK.init.image('heartshield', {width:140, height:125.3, id:'684b5a3e823cf46e816a0938'})
LK.init.image('isyeri', {width:2048, height:2048, id:'684b51e7823cf46e816a0909'})
LK.init.image('kickActive', {width:180, height:176.48, id:'684c287299bba813a7965bdb'})
LK.init.image('kickTarget', {width:180, height:181.42, id:'684c277a99bba813a7965bcd'})
LK.init.image('lostheart', {width:140, height:140, id:'68499d3282aea33b9232d813'})
LK.init.image('mainmanubg', {width:2048, height:2732, id:'684b3561823cf46e816a0758'})
LK.init.image('mainmenu', {width:100, height:57.81, id:'684b6d3f823cf46e816a0a00'})
LK.init.image('missCircle', {width:60, height:59.77, id:'684b450f823cf46e816a084c'})
LK.init.image('pause', {width:100, height:100, id:'684c2f4799bba813a7965c1f'})
LK.init.image('pausemenu', {width:2048, height:2732, id:'684c32fb64438f173d0b1253'})
LK.init.image('perfectcircle', {width:60, height:59.77, id:'684b41dd823cf46e816a0810'})
LK.init.image('purplecircle', {width:180, height:181.59, id:'684c181d99bba813a7965afc'})
LK.init.image('readybutton', {width:100, height:49.61, id:'684b4d4c823cf46e816a08cf'})
LK.init.image('readyinfo', {width:1000, height:1028.1, id:'684c2a7199bba813a7965bfb'})
LK.init.image('restartbutton', {width:100, height:53.13, id:'684c344c64438f173d0b126c'})
LK.init.image('resumebutton', {width:100, height:54.69, id:'684c33c564438f173d0b1262'})
LK.init.image('settingsbar', {width:800, height:140, id:'684c25bc99bba813a7965bbf'})
LK.init.image('settingsbg', {width:2048, height:2732, id:'684b38ae823cf46e816a0793'})
LK.init.image('settingsbutton', {width:100, height:51.95, id:'684b3bdc823cf46e816a07d2'})
LK.init.image('startbutton', {width:100, height:57.81, id:'684b3a20823cf46e816a07af'})
LK.init.image('supportbg', {width:2048, height:2048, id:'684b62c8823cf46e816a0992'})
LK.init.image('supportbutton', {width:100, height:59.38, id:'684b3ccd823cf46e816a07e7'})
LK.init.image('supporttab', {width:150, height:191.04, id:'684b6259823cf46e816a0984'})
LK.init.image('timelineBar', {width:2048, height:50, id:'684b486e823cf46e816a088d'})
LK.init.image('tryagain', {width:100, height:60.16, id:'684b6ac1823cf46e816a09dd'})
LK.init.music('100BPMSynthWave', {volume:0.8, start:0, end:1, id:'684c008d99bba813a79659b6'})
LK.init.music('105BPMHyperDrive', {volume:0.7, start:0, end:1, id:'684c04e899bba813a79659e4'})
LK.init.music('110BPMTechnoRush', {volume:0.6, start:0, end:0.868, id:'684c056699bba813a79659eb'})
LK.init.music('115BPMHighEnergy', {volume:0.7, start:0, end:1, id:'684c05cc99bba813a79659f0'})
LK.init.music('120BPMMaximum', {volume:0.7, start:0, end:1, id:'684c061799bba813a79659f4'})
LK.init.music('40BPMDeepVibes', {volume:0.8, start:0, end:1, id:'684c025e99bba813a79659c0'})
LK.init.music('45BPMChillWave', {volume:0.8, start:0, end:1, id:'684c02d199bba813a79659c6'})
LK.init.music('50BPMSlowMotion', {volume:0.7, start:0, end:1, id:'684c033399bba813a79659cb'})
LK.init.music('55BPMDreamscape', {volume:0.8, start:0, end:1, id:'684c039f99bba813a79659cf'})
LK.init.music('60BPMLowKey', {volume:0.8, start:0, end:1, id:'684c03f599bba813a79659d6'})
LK.init.music('65BPMRelaxed', {volume:0.8, start:0, end:1, id:'684c044f99bba813a79659db'})
LK.init.music('70BPMCalmVibes', {volume:0.8, start:0, end:1, id:'684c04a399bba813a79659e1'})
LK.init.music('75BPMElectricDreams', {volume:1, start:0, end:1, id:'684bfefb99bba813a79659a2'})
LK.init.music('80BPMNeonNights', {volume:1, start:0, end:1, id:'684b3624823cf46e816a0767'})
LK.init.music('85BPMCyberFlow', {volume:1, start:0, end:1, id:'684bff5499bba813a79659a6'})
LK.init.music('90BPMDigitalPulse', {volume:1, start:0, end:1, id:'684bffc999bba813a79659ad'})
LK.init.music('95BPMFutureBass', {volume:0.7, start:0, end:1, id:'684c002b99bba813a79659b1'})
LK.init.sound('buttonclick', {volume:1, start:0.444, end:0.733, id:'684c168299bba813a7965ad8'})
LK.init.sound('hihat', {volume:0.5, start:0, end:0.318, id:'684c1ba799bba813a7965b3e'})
LK.init.sound('hihat2', {volume:0.8, start:0, end:0.202, id:'684c1c1599bba813a7965b52'})
LK.init.sound('hihat3', {volume:0.7, start:0, end:0.398, id:'684c1c5099bba813a7965b5e'})
LK.init.sound('hihat4', {volume:0.6, start:0, end:0.498, id:'684c1c9099bba813a7965b61'})
LK.init.sound('kick', {volume:0.5, start:0.021, end:0.642, id:'6849949782aea33b9232d756'})
LK.init.sound('kick2', {volume:0.5, start:0.02, end:0.944, id:'684c198799bba813a7965b1c'})
LK.init.sound('kick3', {volume:0.5, start:0.031, end:0.756, id:'684c19cf99bba813a7965b22'})
LK.init.sound('kick4', {volume:0.6, start:0.016, end:0.633, id:'684c1a0499bba813a7965b2b'})
LK.init.music('menumusic', {volume:0.8, start:0, end:1, id:'684b641e823cf46e816a09b7'})
LK.init.sound('miss', {volume:0.6, start:0.108, end:0.827, id:'684b5138823cf46e816a0903'})
LK.init.sound('percussion', {volume:0.6, start:0.078, end:1, id:'684c228699bba813a7965b85'})
LK.init.sound('percussion2', {volume:1, start:0, end:0.71, id:'684c22e599bba813a7965b8b'})
LK.init.sound('percussion3', {volume:1, start:0.016, end:0.743, id:'684c231c99bba813a7965b8e'})
LK.init.sound('percussion4', {volume:1, start:0.015, end:0.285, id:'684c235199bba813a7965b92'})
LK.init.sound('scratch', {volume:0.5, start:0, end:0.607, id:'684c0fda99bba813a7965a96'})
LK.init.sound('snareclap', {volume:0.6, start:0, end:0.42, id:'684c1f0d99bba813a7965b6b'})
LK.init.sound('snareclap2', {volume:0.6, start:0, end:0.382, id:'684c1f5799bba813a7965b6f'})
LK.init.sound('snareclap3', {volume:0.4, start:0, end:0.367, id:'684c1f8d99bba813a7965b79'})
LK.init.sound('snareclap4', {volume:0.6, start:0, end:0.403, id:'684c1fd599bba813a7965b7d'})
LK.init.sound('thanks', {volume:1, start:0, end:1, id:'684c2e7d99bba813a7965c16'})

/**** 
* Plugins
****/
var tween = LK.import("@upit/tween.v1");
var storage = LK.import("@upit/storage.v1", {
	bpm: 100,
	soundVolume: 100,
	selectedKickSound: "kick",
	selectedHihatSound: "hihat",
	selectedSnareClapSound: "snareclap",
	selectedPercussionSound: "percussion"
});

/**** 
* Classes
****/
// default bpm 100
// Beat marker class (moving dot)
var BeatMarker = Container.expand(function () {
	var self = Container.call(this);
	var marker = self.attachAsset('beatMarker', {
		anchorX: 0.5,
		anchorY: 0.5
	});
	self.active = true; // Whether this beat is still hittable
	self.hit = false; // Whether this beat was hit
	// For feedback animation
	self.showFeedback = function (type) {
		var feedbackId = type === 'good' ? 'goodCircle' : 'missCircle';
		var feedback = LK.getAsset(feedbackId, {
			anchorX: 0.5,
			anchorY: 0.5,
			x: self.x,
			y: self.y,
			alpha: 0.7,
			scaleX: 1,
			scaleY: 1
		});
		game.addChild(feedback);
		tween(feedback, {
			alpha: 0,
			scaleX: 1.5,
			scaleY: 1.5
		}, {
			duration: 400,
			easing: tween.easeOut,
			onFinish: function onFinish() {
				feedback.destroy();
			}
		});
	};
	return self;
});

/**** 
* Initialize Game
****/
var game = new LK.Game({
	backgroundColor: 0x6ec6f5 // light blue sky
});

/**** 
* Game Code
****/
// --- BPM-specific music assets (kickless versions) ---
// Music (looping, short demo)
// Sound for kick
// Good feedback
// Miss feedback
// Beat marker
// Timeline bar
// Bass drum (kick) hit circle when active
// Bass drum (kick) hit circle
// --- Game constants ---
var TIMELINE_WIDTH = 2048;
var TIMELINE_HEIGHT = 25;
var TIMELINE_Y = 2000; // Y position of timeline bar
var TIMELINE_X = 0;
var HIT_ZONE_X = 2048 / 2; // Center of screen
var HIT_ZONE_Y = TIMELINE_Y + TIMELINE_HEIGHT / 2;
var HIT_WINDOW = 120; // px distance for perfect hit
// Beat speed remains constant - only spacing between beats changes based on BPM
function getBeatSpeed() {
	return 400; // Constant speed of 400 px/s regardless of BPM
}
var INITIAL_BPM = 100; // Starting BPM
var BEATS_PER_MEASURE = 4;
var BEAT_INTERVAL = 60 / INITIAL_BPM; // seconds per beat
var DIFFICULTY_STEP = 0.15; // How much to increase BPM per level
var MAX_MISSES = 5;
// --- Game state ---
var beats = []; // Active BeatMarker objects
var beatPattern = []; // Array of {time, type}
var nextBeatIdx = 0; // Next beat to spawn
var songTime = 0; // Elapsed time in seconds
var lastTickTime = Date.now();
var score = 0;
var misses = 0;
var ignoredMisses = 0; // Track first 3 misses to ignore
var combo = 0;
var bpm = typeof storage.bpm === "number" ? storage.bpm : INITIAL_BPM;
var soundVolume = typeof storage.soundVolume === "number" ? storage.soundVolume : 100;
var selectedKickSound = typeof storage.selectedKickSound === "string" ? storage.selectedKickSound : 'kick';
var selectedHihatSound = typeof storage.selectedHihatSound === "string" ? storage.selectedHihatSound : 'hihat';
var selectedSnareClapSound = typeof storage.selectedSnareClapSound === "string" ? storage.selectedSnareClapSound : 'snareclap';
var selectedPercussionSound = typeof storage.selectedPercussionSound === "string" ? storage.selectedPercussionSound : 'percussion';
// Function to update all sound volumes based on soundVolume setting
function updateAllSoundVolumes() {
	var volumeMultiplier = soundVolume / 100;
	// Update kick sound volume
	var kickSound = LK.getSound(selectedKickSound);
	if (kickSound && kickSound.setVolume) {
		kickSound.setVolume(1 * volumeMultiplier);
	}
	// Update hihat sound volume
	var hihatSound = LK.getSound(selectedHihatSound);
	if (hihatSound && hihatSound.setVolume) {
		hihatSound.setVolume(0.5 * volumeMultiplier);
	}
	// Update snare/clap sound volume
	var snareClapSound = LK.getSound(selectedSnareClapSound);
	if (snareClapSound && snareClapSound.setVolume) {
		snareClapSound.setVolume(0.6 * volumeMultiplier);
	}
	// Update percussion sound volume
	var percussionSound = LK.getSound(selectedPercussionSound);
	if (percussionSound && percussionSound.setVolume) {
		percussionSound.setVolume(0.6 * volumeMultiplier);
	}
	// Update miss sound volume
	var missSound = LK.getSound('miss');
	if (missSound && missSound.setVolume) {
		missSound.setVolume(0.6 * volumeMultiplier);
	}
}
var beatInterval = 60 / bpm;
var gameActive = true;
var feedbackTimeout = null;
// --- UI elements ---
// --- Heart/Life UI ---
// (Initialization moved after scoreTxt is defined)
var MAX_LIVES = 3;
var lives = MAX_LIVES;
var heartIcons = [];
var heartSpacing = 40;
var heartshields = 3; // Number of heartshields remaining
// Heart/life UI will be initialized after scoreTxt is defined
// --- Gameplay Screen Container ---
var gamescreen = new Container();
gamescreen.visible = false;
game.addChild(gamescreen);
// Add isyeri background image, anchored top-left, covering the whole game area
var isyeriBg = LK.getAsset('isyeri', {
	anchorX: 0,
	anchorY: 0,
	x: 0,
	y: 0,
	width: 2048,
	height: 2732
});
gamescreen.addChild(isyeriBg);
var timelineBar = LK.getAsset('timelineBar', {
	anchorX: 0,
	anchorY: 0.5,
	x: TIMELINE_X,
	y: TIMELINE_Y + TIMELINE_HEIGHT / 2
});
gamescreen.addChild(timelineBar);
// Hit zone (kick target)
var kickTarget = LK.getAsset('kickTarget', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: HIT_ZONE_X,
	y: HIT_ZONE_Y
});
gamescreen.addChild(kickTarget);
// Score text - pixelated effect using small size and scale
var scoreTxt = new Text2('0', {
	size: 20,
	fill: 0xFFFFFF
});
scoreTxt.scale.set(6, 6); // Scale up 6x to create more pixelated effect
scoreTxt.anchor.set(0.5, 0);
LK.gui.top.addChild(scoreTxt);
// Combo text
var comboTxt = new Text2('', {
	size: 12,
	fill: 0x00FF00
});
comboTxt.scale.set(6, 6);
comboTxt.anchor.set(0.5, 0);
LK.gui.top.addChild(comboTxt);
comboTxt.y = 120;
// BPM display text - 180px below combo text (moved 20px up)
var bpmDisplayTxt = new Text2(bpm + ' ' + 'BPM', {
	size: 12,
	fill: 0xef69b9
});
bpmDisplayTxt.scale.set(6, 6);
bpmDisplayTxt.anchor.set(0.5, 0);
LK.gui.top.addChild(bpmDisplayTxt);
bpmDisplayTxt.y = comboTxt.y + 180;
// Song name display text - below BPM display
var songNameTxt = new Text2('', {
	size: 12,
	fill: 0xffffff
});
songNameTxt.scale.set(6, 6);
songNameTxt.anchor.set(0.5, 0);
LK.gui.top.addChild(songNameTxt);
songNameTxt.y = bpmDisplayTxt.y + 75;
// Pause button in top right corner (avoiding top-left platform menu)
var pauseBtn = LK.getAsset('pause', {
	anchorX: 1,
	anchorY: 0,
	x: 2048 - 50,
	y: 220,
	scaleX: 1.6,
	scaleY: 1.6
});
gamescreen.addChild(pauseBtn);
// No miss text, only hearts for lives display
// --- Heart/Life UI --- (moved here to ensure scoreTxt is defined)
// Calculate heartY based on scoreTxt position and height
var heartY = scoreTxt.y + 50; // Score text'in 50px altında
var heartWidth = 150;
var totalHeartsWidth = MAX_LIVES * heartWidth + (MAX_LIVES - 1) * heartSpacing;
var heartStartX = 2048 - 100 - totalHeartsWidth; // Sağdan 100px boşluk bırak
// Remove any existing heart icons from their parents before recreating
for (var i = 0; i < heartIcons.length; i++) {
	if (heartIcons[i] && heartIcons[i].parent) {
		heartIcons[i].parent.removeChild(heartIcons[i]);
	}
}
heartIcons = [];
for (var i = 0; i < MAX_LIVES; i++) {
	var heartshield = LK.getAsset('heartshield', {
		anchorX: 0,
		anchorY: 0,
		x: heartStartX + i * (heartWidth + heartSpacing),
		y: heartY
	});
	gamescreen.addChild(heartshield);
	heartIcons.push(heartshield);
}
// --- Beat pattern generation ---
function generateBeatPattern(bpm, measures) {
	// Simple: 4/4, kick on every beat, can add more complex patterns later
	var pattern = [];
	var interval = 60 / bpm; // seconds per beat based on current BPM
	var totalBeats = 100000; // Target 100,000 total beats
	for (var beatIndex = 0; beatIndex < totalBeats; beatIndex++) {
		pattern.push({
			time: beatIndex * interval,
			// Each beat spaced by BPM interval
			type: 'kick'
		});
	}
	return pattern;
}
// --- Start game ---
function startGame() {
	// Reset state
	for (var i = 0; i < beats.length; i++) {
		beats[i].destroy();
	}
	beats = [];
	// Always use current bpm from settings and calculate beatInterval accordingly
	beatInterval = 60 / bpm;
	beatPattern = generateBeatPattern(bpm); // Generate 100,000 beats
	nextBeatIdx = 0;
	songTime = 0;
	lastTickTime = Date.now();
	score = 0;
	misses = 0;
	ignoredMisses = 0; // Reset ignored misses counter
	combo = 0;
	perfectCombo = 0; // Reset perfect combo
	lives = MAX_LIVES;
	heartshields = 3; // Reset heartshields
	lastBpmUpgradeScore = 0; // Reset BPM upgrade tracking
	// Remove any beat that is at the kick target at game start (defensive, in case of bug)
	// Also, prevent initial miss by ensuring no beat is at or past the hit zone at game start
	for (var i = beats.length - 1; i >= 0; i--) {
		if (typeof beats[i].x !== "undefined" && Math.abs(beats[i].x - HIT_ZONE_X) < 2 || typeof beats[i].x !== "undefined" && beats[i].x >= HIT_ZONE_X - HIT_WINDOW) {
			beats[i].destroy();
			beats.splice(i, 1);
		}
	}
	// Defensive: Also ensure no beat is created at the kick target at game start
	if (beats.length > 0 && typeof beats[0].x !== "undefined" && Math.abs(beats[0].x - HIT_ZONE_X) < 2) {
		beats[0].destroy();
		beats.splice(0, 1);
	}
	// Reset heart icons to full heartshields
	// Recalculate miss text width and heart positions on restart
	var heartWidth = 150;
	var totalHeartsWidth = MAX_LIVES * heartWidth + (MAX_LIVES - 1) * heartSpacing;
	var heartStartX = 2048 - 100 - totalHeartsWidth;
	var heartY = scoreTxt.y + 50;
	// Remove all existing heart icons
	for (var i = 0; i < heartIcons.length; i++) {
		if (heartIcons[i] && heartIcons[i].parent) {
			heartIcons[i].parent.removeChild(heartIcons[i]);
		}
	}
	// Recreate all heart icons as full heartshields
	heartIcons = [];
	heartshields = MAX_LIVES; // Reset heartshields counter first
	lives = MAX_LIVES; // Reset lives counter to ensure proper state
	for (var i = 0; i < MAX_LIVES; i++) {
		var heartAsset = LK.getAsset('heartshield', {
			anchorX: 0,
			anchorY: 0,
			x: heartStartX + i * (heartWidth + heartSpacing),
			y: heartY
		});
		gamescreen.addChild(heartAsset);
		heartIcons.push(heartAsset);
	}
	gameActive = true;
	gamePaused = false;
	scoreTxt.setText('0');
	comboTxt.setText('');
	// missTxt removed, only hearts for lives
	kickTarget.visible = true;
	LK.setScore(0);
	// Reapply glow effects after game restart
	applyGlowToVioletElements();
	// Apply current sound volume settings
	updateAllSoundVolumes();
	// Set timeout to remove heartshields after 3 seconds
	tween({}, {}, {
		duration: 3000,
		onFinish: function onFinish() {
			if (gameActive && heartshields > 0) {
				// Convert all remaining heartshields to regular hearts
				for (var i = 0; i < MAX_LIVES; i++) {
					if (heartIcons[i] && heartIcons[i].parent) {
						// Check if this is still a heartshield by checking if heartshields counter allows it
						var shieldIndex = 3 - heartshields;
						if (i >= shieldIndex) {
							// This is a heartshield, convert it to heart
							var parent = heartIcons[i].parent;
							parent.removeChild(heartIcons[i]);
							heartIcons[i] = LK.getAsset('heart', {
								anchorX: 0,
								anchorY: 0,
								x: heartStartX + i * (heartWidth + heartSpacing),
								y: heartY
							});
							gamescreen.addChild(heartIcons[i]);
						}
					}
				}
				// Reset heartshields counter to 0
				heartshields = 0;
			}
		}
	});
	// --- Play correct BPM music (kickless) ---
	var musicId = '100BPMSynthWave'; // Default fallback
	if (bpm === 40) {
		musicId = '40BPMDeepVibes';
	} else if (bpm === 45) {
		musicId = '45BPMChillWave';
	} else if (bpm === 50) {
		musicId = '50BPMSlowMotion';
	} else if (bpm === 55) {
		musicId = '55BPMDreamscape';
	} else if (bpm === 60) {
		musicId = '60BPMLowKey';
	} else if (bpm === 65) {
		musicId = '65BPMRelaxed';
	} else if (bpm === 70) {
		musicId = '70BPMCalmVibes';
	} else if (bpm === 75) {
		musicId = '75BPMElectricDreams';
	} else if (bpm === 80) {
		musicId = '80BPMNeonNights';
	} else if (bpm === 85) {
		musicId = '85BPMCyberFlow';
	} else if (bpm === 90) {
		musicId = '90BPMDigitalPulse';
	} else if (bpm === 95) {
		musicId = '95BPMFutureBass';
	} else if (bpm === 100) {
		musicId = '100BPMSynthWave';
	} else if (bpm === 105) {
		musicId = '105BPMHyperDrive';
	} else if (bpm === 110) {
		musicId = '110BPMTechnoRush';
	} else if (bpm === 115) {
		musicId = '115BPMHighEnergy';
	} else if (bpm === 120) {
		musicId = '120BPMMaximum';
	}
	var volumeMultiplier = soundVolume / 100;
	LK.playMusic(musicId, {
		volume: 1 * volumeMultiplier,
		loop: true
	});
	// Update song name display
	if (songNameTxt) {
		// Remove BPM number and "BPM" text from the beginning
		var songName = musicId.replace(/^\d+BPM/, '');
		songNameTxt.setText(songName);
	}
}
// --- Main Menu Implementation ---
// Add main menu background image, anchored top-left, covering the whole game area
var mainMenuContainer = new Container();
mainMenuContainer.visible = true;
var mainMenuBg = LK.getAsset('mainmanubg', {
	anchorX: 0,
	anchorY: 0,
	x: 0,
	y: 0,
	width: 2048,
	height: 2732
});
mainMenuContainer.addChild(mainMenuBg);
// Title - DJ Asset
var djAsset = LK.getAsset('DJ', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 / 2,
	y: 315,
	scaleX: 8,
	scaleY: 8
});
mainMenuContainer.addChild(djAsset);
// Calculate button positions with 5px spacing
var buttonStartY = 1000;
var buttonHeight = 289; // Approximate height with scale 5
var buttonSpacing = 5;
// Start Button
var startBtn = LK.getAsset('startbutton', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 / 2,
	y: buttonStartY,
	scaleX: 5,
	scaleY: 5
});
mainMenuContainer.addChild(startBtn);
// Settings Button
var settingsBtn = LK.getAsset('settingsbutton', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 / 2,
	y: buttonStartY + buttonHeight + buttonSpacing,
	scaleX: 5,
	scaleY: 5
});
mainMenuContainer.addChild(settingsBtn);
// Credits Button
var creditsBtn = LK.getAsset('creditsbutton', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 / 2,
	y: buttonStartY + 2 * (buttonHeight + buttonSpacing),
	scaleX: 5,
	scaleY: 5
});
mainMenuContainer.addChild(creditsBtn);
// Support Us Button
var supportBtn = LK.getAsset('supportbutton', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 / 2,
	y: buttonStartY + 3 * (buttonHeight + buttonSpacing),
	scaleX: 5,
	scaleY: 5
});
mainMenuContainer.addChild(supportBtn);
// Overlay for credits/settings/support
var settingsmenu = new Container();
settingsmenu.visible = false;
game.addChild(settingsmenu);
var creditsmenu = new Container();
creditsmenu.visible = false;
game.addChild(creditsmenu);
var supportmenu = new Container();
supportmenu.visible = false;
game.addChild(supportmenu);
// Helper to hide all overlays
function hideAllMenus() {
	settingsmenu.visible = false;
	creditsmenu.visible = false;
	supportmenu.visible = false;
}
// Show credits menu
function showCreditsMenu() {
	hideAllMenus();
	creditsmenu.removeChildren();
	var bg = LK.getAsset('creditsbg', {
		anchorX: 0,
		anchorY: 0,
		x: 0,
		y: 0,
		width: 2048,
		height: 2732
	});
	creditsmenu.addChild(bg);
	var creditsTab = LK.getAsset('creditstab', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 2732 / 2,
		scaleX: 10,
		scaleY: 10
	});
	creditsmenu.addChild(creditsTab);
	// Close button (bottom right)
	var closeBtn = LK.getAsset('closebutton', {
		anchorX: 1,
		anchorY: 1,
		x: 2048 - 60,
		y: 2732 - 60,
		scaleX: 3,
		scaleY: 3
	});
	creditsmenu.addChild(closeBtn);
	closeBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation - scale inward then outward
		tween(closeBtn, {
			scaleX: 0.9,
			scaleY: 0.9
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(closeBtn, {
					scaleX: 1,
					scaleY: 1
				}, {
					duration: 120,
					easing: tween.easeOut
				});
			}
		});
		creditsmenu.visible = false;
		mainMenuContainer.visible = true;
	};
	creditsmenu.visible = true;
	// Remove tap-to-close on background
	creditsmenu.down = undefined;
}
// Show support menu
function showSupportMenu() {
	hideAllMenus();
	supportmenu.removeChildren();
	var bg = LK.getAsset('supportbg', {
		anchorX: 0,
		anchorY: 0,
		x: 0,
		y: 0,
		width: 2048,
		height: 2732
	});
	supportmenu.addChild(bg);
	var supportTab = LK.getAsset('supporttab', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 2732 / 2,
		scaleX: 10,
		scaleY: 10
	});
	supportmenu.addChild(supportTab);
	// Close button (bottom right)
	var closeBtn = LK.getAsset('closebutton', {
		anchorX: 1,
		anchorY: 1,
		x: 2048 - 60,
		y: 2732 - 60,
		scaleX: 3,
		scaleY: 3
	});
	supportmenu.addChild(closeBtn);
	closeBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation - scale inward then outward
		tween(closeBtn, {
			scaleX: 0.9,
			scaleY: 0.9
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(closeBtn, {
					scaleX: 1,
					scaleY: 1
				}, {
					duration: 120,
					easing: tween.easeOut
				});
			}
		});
		supportmenu.visible = false;
		mainMenuContainer.visible = true;
	};
	supportmenu.visible = true;
	// Remove tap-to-close on background
	supportmenu.down = undefined;
	// Play thanks sound after 2 seconds
	LK.setTimeout(function () {
		LK.getSound('thanks').play();
	}, 2000);
}
// Show settings menu
function showSettingsMenu() {
	hideAllMenus();
	settingsmenu.removeChildren();
	var bg = LK.getAsset('settingsbg', {
		anchorX: 0,
		anchorY: 0,
		x: 0,
		y: 0,
		width: 2048,
		height: 2732
	});
	settingsmenu.addChild(bg);
	var settingsAsset = LK.getAsset('settingsbutton', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 700,
		scaleX: 8,
		scaleY: 8
	});
	settingsmenu.addChild(settingsAsset);
	// --- BPM CIRCLE UI ---
	// Container for the whole BPM control
	var bpmCircleContainer = new Container();
	bpmCircleContainer.x = 2048 / 2 - 300;
	bpmCircleContainer.y = 1100;
	settingsmenu.addChild(bpmCircleContainer);
	// --- KICK SOUND SELECTION UI ---
	// Container for kick sound selection
	var kickSoundContainer = new Container();
	kickSoundContainer.x = 2048 / 2;
	kickSoundContainer.y = 1400;
	settingsmenu.addChild(kickSoundContainer);
	// Kick sound label
	var kickSoundLabelTxt = new Text2("KICK SOUND", {
		size: 12,
		fill: 0xffffff
	});
	kickSoundLabelTxt.scale.set(4, 4);
	kickSoundLabelTxt.anchor.set(0.5, 0.5);
	kickSoundLabelTxt.x = 0;
	kickSoundLabelTxt.y = -120;
	kickSoundContainer.addChild(kickSoundLabelTxt);
	// Add settingsbar background behind kick buttons
	var kickSettingsBar = LK.getAsset('settingsbar', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.2,
		scaleY: 1.2,
		alpha: 0.8
	});
	kickSoundContainer.addChild(kickSettingsBar);
	// Create kick sound buttons
	var kickSounds = ['kick', 'kick2', 'kick3', 'kick4'];
	var kickButtons = [];
	var buttonSpacing = 220;
	var startX = -330;
	for (var i = 0; i < kickSounds.length; i++) {
		var kickButton = LK.getAsset('purplecircle', {
			anchorX: 0.5,
			anchorY: 0.5,
			x: startX + i * buttonSpacing,
			y: 0,
			scaleX: 0.8,
			scaleY: 0.8,
			alpha: selectedKickSound === kickSounds[i] ? 1 : 0.5
		});
		kickSoundContainer.addChild(kickButton);
		// Add number text to button
		var numberTxt = new Text2(i + 1 + "", {
			size: 18,
			fill: 0xffffff
		});
		numberTxt.scale.set(4, 4);
		numberTxt.anchor.set(0.5, 0.5);
		numberTxt.x = startX + i * buttonSpacing;
		numberTxt.y = 0;
		kickSoundContainer.addChild(numberTxt);
		kickButton.kickSoundId = kickSounds[i];
		kickButton.buttonIndex = i;
		kickButtons.push(kickButton);
		// Button click handler
		kickButton.down = function (x, y, obj) {
			// If this is already selected kick sound and any other sound is selected, deselect all kick sounds
			if (selectedKickSound === this.kickSoundId && (selectedHihatSound !== '' || selectedSnareClapSound !== '' || selectedPercussionSound !== '')) {
				// Play the selected kick sound
				LK.getSound(this.kickSoundId).play();
				// Deselect all kick sounds
				selectedKickSound = '';
				storage.selectedKickSound = selectedKickSound;
				// Update button appearances - all kick buttons become inactive
				for (var j = 0; j < kickButtons.length; j++) {
					kickButtons[j].alpha = 0.5;
				}
				// Animate button
				tween(this, {
					scaleX: 0.9,
					scaleY: 0.9
				}, {
					duration: 80,
					easing: tween.easeIn,
					onFinish: function () {
						tween(this, {
							scaleX: 0.8,
							scaleY: 0.8
						}, {
							duration: 120,
							easing: tween.easeOut
						});
					}.bind(this)
				});
				return;
			}
			// If this is already selected and it's the only one selected, don't allow deselection
			if (selectedKickSound === this.kickSoundId && selectedHihatSound === '' && selectedSnareClapSound === '' && selectedPercussionSound === '') {
				// Play the selected kick sound
				LK.getSound(this.kickSoundId).play();
				return; // Don't deselect if it would leave no sound selected
			}
			// Play the selected kick sound
			LK.getSound(this.kickSoundId).play();
			// Update selected kick sound
			selectedKickSound = this.kickSoundId;
			storage.selectedKickSound = selectedKickSound;
			// Update button appearances
			for (var j = 0; j < kickButtons.length; j++) {
				kickButtons[j].alpha = j === this.buttonIndex ? 1 : 0.5;
			}
			// Animate button
			tween(this, {
				scaleX: 0.9,
				scaleY: 0.9
			}, {
				duration: 80,
				easing: tween.easeIn,
				onFinish: function () {
					tween(this, {
						scaleX: 0.8,
						scaleY: 0.8
					}, {
						duration: 120,
						easing: tween.easeOut
					});
				}.bind(this)
			});
		}.bind(kickButton);
	}
	// --- HIHAT SOUND SELECTION UI ---
	// Container for hihat sound selection
	var hihatSoundContainer = new Container();
	hihatSoundContainer.x = 2048 / 2;
	hihatSoundContainer.y = 1700;
	settingsmenu.addChild(hihatSoundContainer);
	// Hihat sound label
	var hihatSoundLabelTxt = new Text2("HI HATS", {
		size: 12,
		fill: 0xffffff
	});
	hihatSoundLabelTxt.scale.set(4, 4);
	hihatSoundLabelTxt.anchor.set(0.5, 0.5);
	hihatSoundLabelTxt.x = 0;
	hihatSoundLabelTxt.y = -120;
	hihatSoundContainer.addChild(hihatSoundLabelTxt);
	// Add settingsbar background behind hihat buttons
	var hihatSettingsBar = LK.getAsset('settingsbar', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.2,
		scaleY: 1.2,
		alpha: 0.8
	});
	hihatSoundContainer.addChild(hihatSettingsBar);
	// Create hihat sound buttons
	var hihatSounds = ['hihat', 'hihat2', 'hihat3', 'hihat4'];
	var hihatButtons = [];
	var hihatButtonSpacing = 220;
	var hihatStartX = -330;
	for (var i = 0; i < hihatSounds.length; i++) {
		var hihatButton = LK.getAsset('purplecircle', {
			anchorX: 0.5,
			anchorY: 0.5,
			x: hihatStartX + i * hihatButtonSpacing,
			y: 0,
			scaleX: 0.8,
			scaleY: 0.8,
			alpha: selectedHihatSound === hihatSounds[i] ? 1 : 0.5
		});
		hihatSoundContainer.addChild(hihatButton);
		// Add number text to button
		var numberTxt = new Text2(i + 1 + "", {
			size: 18,
			fill: 0xffffff
		});
		numberTxt.scale.set(4, 4);
		numberTxt.anchor.set(0.5, 0.5);
		numberTxt.x = hihatStartX + i * hihatButtonSpacing;
		numberTxt.y = 0;
		hihatSoundContainer.addChild(numberTxt);
		hihatButton.hihatSoundId = hihatSounds[i];
		hihatButton.buttonIndex = i;
		hihatButtons.push(hihatButton);
		// Button click handler
		hihatButton.down = function (x, y, obj) {
			// If this is already selected hihat sound and any other sound is selected, deselect all hihat sounds
			if (selectedHihatSound === this.hihatSoundId && (selectedKickSound !== '' || selectedSnareClapSound !== '' || selectedPercussionSound !== '')) {
				// Play the selected hihat sound
				LK.getSound(this.hihatSoundId).play();
				// Deselect all hihat sounds
				selectedHihatSound = '';
				storage.selectedHihatSound = selectedHihatSound;
				// Update button appearances - all hihat buttons become inactive
				for (var j = 0; j < hihatButtons.length; j++) {
					hihatButtons[j].alpha = 0.5;
				}
				// Animate button
				tween(this, {
					scaleX: 0.9,
					scaleY: 0.9
				}, {
					duration: 80,
					easing: tween.easeIn,
					onFinish: function () {
						tween(this, {
							scaleX: 0.8,
							scaleY: 0.8
						}, {
							duration: 120,
							easing: tween.easeOut
						});
					}.bind(this)
				});
				return;
			}
			// If this is already selected and it's the only one selected, don't allow deselection
			if (selectedHihatSound === this.hihatSoundId && selectedKickSound === '' && selectedSnareClapSound === '' && selectedPercussionSound === '') {
				// Play the selected hihat sound
				LK.getSound(this.hihatSoundId).play();
				return; // Don't deselect if it would leave no sound selected
			}
			// Play the selected hihat sound
			LK.getSound(this.hihatSoundId).play();
			// Update selected hihat sound
			selectedHihatSound = this.hihatSoundId;
			storage.selectedHihatSound = selectedHihatSound;
			// Update button appearances
			for (var j = 0; j < hihatButtons.length; j++) {
				hihatButtons[j].alpha = j === this.buttonIndex ? 1 : 0.5;
			}
			// Animate button
			tween(this, {
				scaleX: 0.9,
				scaleY: 0.9
			}, {
				duration: 80,
				easing: tween.easeIn,
				onFinish: function () {
					tween(this, {
						scaleX: 0.8,
						scaleY: 0.8
					}, {
						duration: 120,
						easing: tween.easeOut
					});
				}.bind(this)
			});
		}.bind(hihatButton);
	}
	// --- SNARE/CLAP SOUND SELECTION UI ---
	// Container for snare/clap sound selection
	var snareClapSoundContainer = new Container();
	snareClapSoundContainer.x = 2048 / 2;
	snareClapSoundContainer.y = 2000;
	settingsmenu.addChild(snareClapSoundContainer);
	// Snare/clap sound label
	var snareClapSoundLabelTxt = new Text2("SNARE/CLAP", {
		size: 12,
		fill: 0xffffff
	});
	snareClapSoundLabelTxt.scale.set(4, 4);
	snareClapSoundLabelTxt.anchor.set(0.5, 0.5);
	snareClapSoundLabelTxt.x = 0;
	snareClapSoundLabelTxt.y = -120;
	snareClapSoundContainer.addChild(snareClapSoundLabelTxt);
	// Add settingsbar background behind snare/clap buttons
	var snareClapSettingsBar = LK.getAsset('settingsbar', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.2,
		scaleY: 1.2,
		alpha: 0.8
	});
	snareClapSoundContainer.addChild(snareClapSettingsBar);
	// Create snare/clap sound buttons
	var snareClapSounds = ['snareclap', 'snareclap2', 'snareclap3', 'snareclap4'];
	var snareClapButtons = [];
	var snareClapButtonSpacing = 220;
	var snareClapStartX = -330;
	for (var i = 0; i < snareClapSounds.length; i++) {
		var snareClapButton = LK.getAsset('purplecircle', {
			anchorX: 0.5,
			anchorY: 0.5,
			x: snareClapStartX + i * snareClapButtonSpacing,
			y: 0,
			scaleX: 0.8,
			scaleY: 0.8,
			alpha: selectedSnareClapSound === snareClapSounds[i] ? 1 : 0.5
		});
		snareClapSoundContainer.addChild(snareClapButton);
		// Add number text to button
		var numberTxt = new Text2(i + 1 + "", {
			size: 18,
			fill: 0xffffff
		});
		numberTxt.scale.set(4, 4);
		numberTxt.anchor.set(0.5, 0.5);
		numberTxt.x = snareClapStartX + i * snareClapButtonSpacing;
		numberTxt.y = 0;
		snareClapSoundContainer.addChild(numberTxt);
		snareClapButton.snareClapSoundId = snareClapSounds[i];
		snareClapButton.buttonIndex = i;
		snareClapButtons.push(snareClapButton);
		// Button click handler
		snareClapButton.down = function (x, y, obj) {
			// If this is already selected snare/clap sound and any other sound is selected, deselect all snare/clap sounds
			if (selectedSnareClapSound === this.snareClapSoundId && (selectedKickSound !== '' || selectedHihatSound !== '' || selectedPercussionSound !== '')) {
				// Play the selected snare/clap sound
				LK.getSound(this.snareClapSoundId).play();
				// Deselect all snare/clap sounds
				selectedSnareClapSound = '';
				storage.selectedSnareClapSound = selectedSnareClapSound;
				// Update button appearances - all snare/clap buttons become inactive
				for (var j = 0; j < snareClapButtons.length; j++) {
					snareClapButtons[j].alpha = 0.5;
				}
				// Animate button
				tween(this, {
					scaleX: 0.9,
					scaleY: 0.9
				}, {
					duration: 80,
					easing: tween.easeIn,
					onFinish: function () {
						tween(this, {
							scaleX: 0.8,
							scaleY: 0.8
						}, {
							duration: 120,
							easing: tween.easeOut
						});
					}.bind(this)
				});
				return;
			}
			// If this is already selected and it's the only one selected, don't allow deselection
			if (selectedSnareClapSound === this.snareClapSoundId && selectedKickSound === '' && selectedHihatSound === '' && selectedPercussionSound === '') {
				// Play the selected snare/clap sound
				LK.getSound(this.snareClapSoundId).play();
				return; // Don't deselect if it would leave no sound selected
			}
			// Play the selected snare/clap sound
			LK.getSound(this.snareClapSoundId).play();
			// Update selected snare/clap sound
			selectedSnareClapSound = this.snareClapSoundId;
			storage.selectedSnareClapSound = selectedSnareClapSound;
			// Update button appearances
			for (var j = 0; j < snareClapButtons.length; j++) {
				snareClapButtons[j].alpha = j === this.buttonIndex ? 1 : 0.5;
			}
			// Animate button
			tween(this, {
				scaleX: 0.9,
				scaleY: 0.9
			}, {
				duration: 80,
				easing: tween.easeIn,
				onFinish: function () {
					tween(this, {
						scaleX: 0.8,
						scaleY: 0.8
					}, {
						duration: 120,
						easing: tween.easeOut
					});
				}.bind(this)
			});
		}.bind(snareClapButton);
	}
	// --- PERCUSSION SOUND SELECTION UI ---
	// Container for percussion sound selection
	var percussionSoundContainer = new Container();
	percussionSoundContainer.x = 2048 / 2;
	percussionSoundContainer.y = 2300;
	settingsmenu.addChild(percussionSoundContainer);
	// Percussion sound label
	var percussionSoundLabelTxt = new Text2("PERCUSSION", {
		size: 12,
		fill: 0xffffff
	});
	percussionSoundLabelTxt.scale.set(4, 4);
	percussionSoundLabelTxt.anchor.set(0.5, 0.5);
	percussionSoundLabelTxt.x = 0;
	percussionSoundLabelTxt.y = -120;
	percussionSoundContainer.addChild(percussionSoundLabelTxt);
	// Add settingsbar background behind percussion buttons
	var percussionSettingsBar = LK.getAsset('settingsbar', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.2,
		scaleY: 1.2,
		alpha: 0.8
	});
	percussionSoundContainer.addChild(percussionSettingsBar);
	// Create percussion sound buttons
	var percussionSounds = ['percussion', 'percussion2', 'percussion3', 'percussion4'];
	var percussionButtons = [];
	var percussionButtonSpacing = 220;
	var percussionStartX = -330;
	for (var i = 0; i < percussionSounds.length; i++) {
		var percussionButton = LK.getAsset('purplecircle', {
			anchorX: 0.5,
			anchorY: 0.5,
			x: percussionStartX + i * percussionButtonSpacing,
			y: 0,
			scaleX: 0.8,
			scaleY: 0.8,
			alpha: selectedPercussionSound === percussionSounds[i] ? 1 : 0.5
		});
		percussionSoundContainer.addChild(percussionButton);
		// Add number text to button
		var numberTxt = new Text2(i + 1 + "", {
			size: 18,
			fill: 0xffffff
		});
		numberTxt.scale.set(4, 4);
		numberTxt.anchor.set(0.5, 0.5);
		numberTxt.x = percussionStartX + i * percussionButtonSpacing;
		numberTxt.y = 0;
		percussionSoundContainer.addChild(numberTxt);
		percussionButton.percussionSoundId = percussionSounds[i];
		percussionButton.buttonIndex = i;
		percussionButtons.push(percussionButton);
		// Button click handler
		percussionButton.down = function (x, y, obj) {
			// If this is already selected percussion sound and any other sound is selected, deselect all percussion sounds
			if (selectedPercussionSound === this.percussionSoundId && (selectedKickSound !== '' || selectedHihatSound !== '' || selectedSnareClapSound !== '')) {
				// Play the selected percussion sound
				LK.getSound(this.percussionSoundId).play();
				// Deselect all percussion sounds
				selectedPercussionSound = '';
				storage.selectedPercussionSound = selectedPercussionSound;
				// Update button appearances - all percussion buttons become inactive
				for (var j = 0; j < percussionButtons.length; j++) {
					percussionButtons[j].alpha = 0.5;
				}
				// Animate button
				tween(this, {
					scaleX: 0.9,
					scaleY: 0.9
				}, {
					duration: 80,
					easing: tween.easeIn,
					onFinish: function () {
						tween(this, {
							scaleX: 0.8,
							scaleY: 0.8
						}, {
							duration: 120,
							easing: tween.easeOut
						});
					}.bind(this)
				});
				return;
			}
			// If this is already selected and it's the only one selected, don't allow deselection
			if (selectedPercussionSound === this.percussionSoundId && selectedKickSound === '' && selectedHihatSound === '' && selectedSnareClapSound === '') {
				// Play the selected percussion sound
				LK.getSound(this.percussionSoundId).play();
				return; // Don't deselect if it would leave no sound selected
			}
			// Play the selected percussion sound
			LK.getSound(this.percussionSoundId).play();
			// Update selected percussion sound
			selectedPercussionSound = this.percussionSoundId;
			storage.selectedPercussionSound = selectedPercussionSound;
			// Update button appearances
			for (var j = 0; j < percussionButtons.length; j++) {
				percussionButtons[j].alpha = j === this.buttonIndex ? 1 : 0.5;
			}
			// Animate button
			tween(this, {
				scaleX: 0.9,
				scaleY: 0.9
			}, {
				duration: 80,
				easing: tween.easeIn,
				onFinish: function () {
					tween(this, {
						scaleX: 0.8,
						scaleY: 0.8
					}, {
						duration: 120,
						easing: tween.easeOut
					});
				}.bind(this)
			});
		}.bind(percussionButton);
	}
	// --- SOUND VOLUME CIRCLE UI ---
	// Container for the whole sound volume control
	var volumeCircleContainer = new Container();
	volumeCircleContainer.x = 2048 / 2 + 300;
	volumeCircleContainer.y = 1100;
	settingsmenu.addChild(volumeCircleContainer);
	// Circle background
	var bpmCircleBg = LK.getAsset('purplecircle', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.1,
		scaleY: 1.1,
		alpha: 0.85
	});
	bpmCircleContainer.addChild(bpmCircleBg);
	// BPM value text
	var bpmValueTxt = new Text2(bpm + "", {
		size: 18,
		fill: 0xffffff
	});
	bpmValueTxt.scale.set(6, 6);
	bpmValueTxt.anchor.set(0.5, 0.5);
	bpmValueTxt.x = 0;
	bpmValueTxt.y = 0;
	bpmCircleContainer.addChild(bpmValueTxt);
	// BPM label text
	var bpmLabelTxt = new Text2("BPM", {
		size: 8,
		fill: 0xffffff
	});
	bpmLabelTxt.scale.set(6, 6);
	bpmLabelTxt.anchor.set(0.5, 0.5);
	bpmLabelTxt.x = 0;
	bpmLabelTxt.y = 90;
	bpmCircleContainer.addChild(bpmLabelTxt);
	// Volume circle background
	var volumeCircleBg = LK.getAsset('purplecircle', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 0,
		y: 0,
		scaleX: 1.1,
		scaleY: 1.1,
		alpha: 0.85
	});
	volumeCircleContainer.addChild(volumeCircleBg);
	// Volume value text
	var volumeValueTxt = new Text2((typeof storage.soundVolume === "number" ? storage.soundVolume : 100) + "", {
		size: 18,
		fill: 0xffffff
	});
	volumeValueTxt.scale.set(6, 6);
	volumeValueTxt.anchor.set(0.5, 0.5);
	volumeValueTxt.x = 0;
	volumeValueTxt.y = 0;
	volumeCircleContainer.addChild(volumeValueTxt);
	// Volume label text
	var volumeLabelTxt = new Text2("SOUND", {
		size: 8,
		fill: 0xffffff
	});
	volumeLabelTxt.scale.set(6, 6);
	volumeLabelTxt.anchor.set(0.5, 0.5);
	volumeLabelTxt.x = 0;
	volumeLabelTxt.y = 90;
	volumeCircleContainer.addChild(volumeLabelTxt);
	// --- Drag-to-change BPM logic ---
	var dragActive = false;
	var dragStartY = 0;
	var dragStartBpm = 0;
	var lastDragStep = 0;
	var BPM_MIN = 40;
	var BPM_MAX = 120;
	var BPM_STEP = 5;
	var PIXELS_PER_STEP = 20;
	// Touch start (down) on circle
	bpmCircleContainer.down = function (x, y, obj) {
		dragActive = true;
		dragStartY = y;
		dragStartBpm = bpm;
		lastDragStep = 0;
		// Animate circle slightly for feedback
		tween(bpmCircleBg, {
			scaleX: 1.18,
			scaleY: 1.18
		}, {
			duration: 100,
			yoyo: true,
			repeat: 1
		});
	};
	// Touch move on circle
	bpmCircleContainer.move = function (x, y, obj) {
		if (!dragActive) {
			return;
		}
		var dy = dragStartY - y; // Up is positive
		var step = Math.floor(dy / PIXELS_PER_STEP);
		if (step !== lastDragStep) {
			var newBpm = dragStartBpm + step * BPM_STEP;
			if (newBpm < BPM_MIN) {
				newBpm = BPM_MIN;
			}
			if (newBpm > BPM_MAX) {
				newBpm = BPM_MAX;
			}
			if (newBpm !== bpm) {
				bpm = newBpm;
				bpmValueTxt.setText(bpm + "");
				beatInterval = 60 / bpm; // Recalculate beat interval for new BPM
				// Regenerate beat pattern with new BPM intervals
				beatPattern = generateBeatPattern(bpm);
				nextBeatIdx = 0; // Reset beat spawning
				storage.bpm = bpm; // persist bpm to storage
				// Play scratch sound when BPM changes during settings
				LK.getSound('scratch').play();
				if (bpmDisplayTxt) {
					bpmDisplayTxt.setText(bpm + ' BPM');
				}
			}
			lastDragStep = step;
		}
	};
	// Touch end (up) on circle
	bpmCircleContainer.up = function (x, y, obj) {
		dragActive = false;
		// Animate back to normal scale
		tween(bpmCircleBg, {
			scaleX: 1.1,
			scaleY: 1.1
		}, {
			duration: 100
		});
	};
	// --- Volume drag logic ---
	var volumeDragActive = false;
	var volumeDragStartY = 0;
	var volumeDragStartValue = 0;
	var volumeLastDragStep = 0;
	var VOLUME_MIN = 0;
	var VOLUME_MAX = 100;
	var VOLUME_STEP = 5;
	var VOLUME_PIXELS_PER_STEP = 20;
	// Touch start (down) on volume circle
	volumeCircleContainer.down = function (x, y, obj) {
		volumeDragActive = true;
		volumeDragStartY = y;
		volumeDragStartValue = soundVolume;
		volumeLastDragStep = 0;
		// Animate circle slightly for feedback
		tween(volumeCircleBg, {
			scaleX: 1.18,
			scaleY: 1.18
		}, {
			duration: 100,
			yoyo: true,
			repeat: 1
		});
	};
	// Touch move on volume circle
	volumeCircleContainer.move = function (x, y, obj) {
		if (!volumeDragActive) {
			return;
		}
		var dy = volumeDragStartY - y; // Up is positive
		var step = Math.floor(dy / VOLUME_PIXELS_PER_STEP);
		if (step !== volumeLastDragStep) {
			var newVolume = volumeDragStartValue + step * VOLUME_STEP;
			if (newVolume < VOLUME_MIN) {
				newVolume = VOLUME_MIN;
			}
			if (newVolume > VOLUME_MAX) {
				newVolume = VOLUME_MAX;
			}
			if (newVolume !== soundVolume) {
				soundVolume = newVolume;
				volumeValueTxt.setText(soundVolume + "");
				storage.soundVolume = soundVolume; // persist volume to storage
				updateAllSoundVolumes(); // Update all sound volumes immediately
				// Update current playing music volume immediately
				var currentVolumeMultiplier = soundVolume / 100;
				LK.playMusic('menumusic', {
					volume: 0.8 * currentVolumeMultiplier,
					loop: true
				});
			}
			volumeLastDragStep = step;
		}
	};
	// Touch end (up) on volume circle
	volumeCircleContainer.up = function (x, y, obj) {
		volumeDragActive = false;
		// Animate back to normal scale
		tween(volumeCircleBg, {
			scaleX: 1.1,
			scaleY: 1.1
		}, {
			duration: 100
		});
	};
	// Close button (bottom right)
	var closeBtn = LK.getAsset('closebutton', {
		anchorX: 1,
		anchorY: 1,
		x: 2048 - 60,
		y: 2732 - 60,
		scaleX: 3,
		scaleY: 3
	});
	settingsmenu.addChild(closeBtn);
	closeBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation - scale inward then outward
		tween(closeBtn, {
			scaleX: 0.9,
			scaleY: 0.9
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(closeBtn, {
					scaleX: 1,
					scaleY: 1
				}, {
					duration: 120,
					easing: tween.easeOut
				});
			}
		});
		settingsmenu.visible = false;
		mainMenuContainer.visible = true;
	};
	// Remove tap-to-close on background
	settingsmenu.down = undefined;
	settingsmenu.visible = true;
}
// Button event handlers
// Countdown logic
var countdownContainer = new Container();
countdownContainer.visible = false;
game.addChild(countdownContainer);
// Pre-game ready screen container
var readyContainer = new Container();
readyContainer.visible = false;
game.addChild(readyContainer);
function showReadyScreen(onReady) {
	gamescreen.visible = true;
	readyContainer.visible = true;
	readyContainer.removeChildren();
	// Show arrowtap area
	var arrowTap = LK.getAsset('arrowtap', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: HIT_ZONE_X - 150,
		y: HIT_ZONE_Y + 250,
		scaleX: 3,
		scaleY: 3
	});
	readyContainer.addChild(arrowTap);
	// Show ready button
	var readyBtn = LK.getAsset('readybutton', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 2732 / 2 + 350,
		scaleX: 6,
		scaleY: 6
	});
	readyContainer.addChild(readyBtn);
	// Add readyinfo asset on top of readybutton
	var readyInfo = LK.getAsset('readyinfo', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 2732 / 2 - 375,
		scaleX: 1.1,
		scaleY: 1.1
	});
	readyContainer.addChild(readyInfo);
	// Ready button click handler
	readyBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation
		tween(readyBtn, {
			scaleX: 7.2,
			scaleY: 7.2
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(readyBtn, {
					scaleX: 8,
					scaleY: 8
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						readyContainer.visible = false;
						readyContainer.removeChildren();
						if (typeof onReady === "function") {
							onReady();
						}
					}
				});
			}
		});
	};
}
function showCountdown(onFinish) {
	gamescreen.visible = true;
	countdownContainer.visible = true;
	countdownContainer.removeChildren();
	var numbers = ["3", "2", "1"];
	var idx = 0;
	function showNext() {
		if (idx >= numbers.length) {
			countdownContainer.visible = false;
			countdownContainer.removeChildren();
			// Only show gamescreen if game is active (startGame will set it visible)
			if (!gameActive) {
				gamescreen.visible = false;
			}
			if (typeof onFinish === "function") {
				onFinish();
			}
			return;
		}
		countdownContainer.removeChildren();
		var txt = new Text2(numbers[idx], {
			size: 600,
			fill: 0xffd700
		});
		txt.scale.set(160, 160);
		txt.anchor.set(0.5, 0.5);
		txt.x = 2048 / 2;
		txt.y = 1200;
		txt.alpha = 0;
		txt.scale.x = 0.6;
		txt.scale.y = 0.6;
		countdownContainer.addChild(txt);
		// Animate in
		tween(txt, {
			alpha: 1,
			scaleX: 1,
			scaleY: 1
		}, {
			duration: 250,
			easing: tween.cubicOut,
			onFinish: function onFinish() {
				// Hold, then animate out
				tween(txt, {
					alpha: 0,
					scaleX: 1.5,
					scaleY: 1.5
				}, {
					duration: 350,
					delay: 400,
					easing: tween.cubicIn,
					onFinish: function onFinish() {
						idx++;
						showNext();
					}
				});
			}
		});
	}
	idx = 0;
	showNext();
}
startBtn.down = function (x, y, obj) {
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Stop menu music immediately and fade out over 1 second
	LK.stopMusic();
	var volumeMultiplier = soundVolume / 100;
	LK.playMusic('menumusic', {
		volume: 0.8 * volumeMultiplier,
		fade: {
			start: 1,
			end: 0,
			duration: 1000
		}
	});
	// Click animation - scale inward then outward
	tween(startBtn, {
		scaleX: 4.5,
		scaleY: 4.5
	}, {
		duration: 80,
		easing: tween.easeIn,
		onFinish: function onFinish() {
			tween(startBtn, {
				scaleX: 5,
				scaleY: 5
			}, {
				duration: 120,
				easing: tween.easeOut,
				onFinish: function onFinish() {
					mainMenuContainer.visible = false;
					showReadyScreen(function () {
						showCountdown(function () {
							startGame();
						});
					});
				}
			});
		}
	});
};
settingsBtn.down = function (x, y, obj) {
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Click animation - scale inward then outward
	tween(settingsBtn, {
		scaleX: 4.5,
		scaleY: 4.5
	}, {
		duration: 80,
		easing: tween.easeIn,
		onFinish: function onFinish() {
			tween(settingsBtn, {
				scaleX: 5,
				scaleY: 5
			}, {
				duration: 120,
				easing: tween.easeOut,
				onFinish: function onFinish() {
					mainMenuContainer.visible = false;
					showSettingsMenu();
				}
			});
		}
	});
};
creditsBtn.down = function (x, y, obj) {
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Click animation - scale inward then outward
	tween(creditsBtn, {
		scaleX: 4.5,
		scaleY: 4.5
	}, {
		duration: 80,
		easing: tween.easeIn,
		onFinish: function onFinish() {
			tween(creditsBtn, {
				scaleX: 5,
				scaleY: 5
			}, {
				duration: 120,
				easing: tween.easeOut,
				onFinish: function onFinish() {
					mainMenuContainer.visible = false;
					showCreditsMenu();
				}
			});
		}
	});
};
supportBtn.down = function (x, y, obj) {
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Click animation - scale inward then outward
	tween(supportBtn, {
		scaleX: 4.5,
		scaleY: 4.5
	}, {
		duration: 80,
		easing: tween.easeIn,
		onFinish: function onFinish() {
			tween(supportBtn, {
				scaleX: 5,
				scaleY: 5
			}, {
				duration: 120,
				easing: tween.easeOut,
				onFinish: function onFinish() {
					mainMenuContainer.visible = false;
					showSupportMenu();
				}
			});
		}
	});
};
// Music mute button in bottom corner of main menu
var musicMuted = typeof storage.musicMuted === "boolean" ? storage.musicMuted : false;
var musicMuteBtn = LK.getAsset('purplecircle', {
	anchorX: 0.5,
	anchorY: 0.5,
	x: 2048 - 150,
	y: 2732 - 150,
	scaleX: 0.8,
	scaleY: 0.8,
	alpha: musicMuted ? 0.5 : 1
});
mainMenuContainer.addChild(musicMuteBtn);
// Music icon text on button
var musicIconTxt = new Text2(musicMuted ? "M" : "♪", {
	size: 24,
	fill: 0xffffff
});
musicIconTxt.scale.set(4, 4);
musicIconTxt.anchor.set(0.5, 0.5);
musicIconTxt.x = 2048 - 150;
musicIconTxt.y = 2732 - 150;
mainMenuContainer.addChild(musicIconTxt);
// Music mute button handler
musicMuteBtn.down = function (x, y, obj) {
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Toggle mute state
	musicMuted = !musicMuted;
	storage.musicMuted = musicMuted;
	// Update button appearance
	musicMuteBtn.alpha = musicMuted ? 0.5 : 1;
	musicIconTxt.setText(musicMuted ? "M" : "♪");
	// Handle music playback
	if (musicMuted) {
		LK.stopMusic();
	} else {
		var volumeMultiplier = soundVolume / 100;
		LK.playMusic('menumusic', {
			volume: 0.8 * volumeMultiplier,
			loop: true
		});
	}
	// Click animation
	tween(musicMuteBtn, {
		scaleX: 0.72,
		scaleY: 0.72
	}, {
		duration: 80,
		easing: tween.easeIn,
		onFinish: function onFinish() {
			tween(musicMuteBtn, {
				scaleX: 0.8,
				scaleY: 0.8
			}, {
				duration: 120,
				easing: tween.easeOut
			});
		}
	});
};
// Add menu to game
game.addChild(mainMenuContainer);
// menus are already added above
// Hide all gameplay UI until game starts
scoreTxt.visible = false;
comboTxt.visible = false;
bpmDisplayTxt.visible = false;
songNameTxt.visible = false;
// missTxt removed, only hearts for lives
// timelineBar and kickTarget are now children of gamescreen, so their visibility is managed by gamescreen
// Patch startGame to show gameplay UI and gamescreen
var _originalStartGame = startGame;
startGame = function startGame() {
	scoreTxt.visible = true;
	comboTxt.visible = true;
	bpmDisplayTxt.visible = true;
	songNameTxt.visible = true;
	if (bpmDisplayTxt) {
		bpmDisplayTxt.setText(bpm + ' BPM');
	}
	// missTxt removed, only hearts for lives
	gamescreen.visible = true;
	mainMenuContainer.visible = false;
	// overlayContainer.visible = false; // Removed, not defined
	_originalStartGame();
};
// On menu, hide gameplay UI and gamescreen
mainMenuContainer.visible = true;
scoreTxt.visible = false;
comboTxt.visible = false;
bpmDisplayTxt.visible = false;
songNameTxt.visible = false;
gamescreen.visible = false;
// Play menu music when in main menu (only if not muted)
if (!musicMuted) {
	var volumeMultiplier = soundVolume / 100;
	LK.playMusic('menumusic', {
		volume: 0.8 * volumeMultiplier,
		loop: true
	});
}
// Apply current sound volume settings to all sounds
updateAllSoundVolumes();
// Pause button functionality
pauseBtn.down = function (x, y, obj) {
	if (!gameActive || !gamescreen.visible) {
		return;
	}
	// Play button click sound
	LK.getSound('buttonclick').play();
	// Pause the game
	gamePaused = true;
	showPauseMenu();
	// No animation - button scale remains fixed at 1.6
};
// Show pause menu function
function showPauseMenu() {
	pauseContainer.visible = true;
	pauseContainer.removeChildren();
	// Hide BPM and song name in pause menu
	bpmDisplayTxt.visible = false;
	songNameTxt.visible = false;
	// Pause menu background
	var pauseMenuBg = LK.getAsset('pausemenu', {
		anchorX: 0,
		anchorY: 0,
		x: 0,
		y: 0,
		width: 2048,
		height: 2732
	});
	pauseContainer.addChild(pauseMenuBg);
	// Button positions
	var pauseButtonStartY = 1200;
	var pauseButtonHeight = 289;
	var pauseButtonSpacing = 20;
	// Resume button
	var resumeBtn = LK.getAsset('resumebutton', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: pauseButtonStartY,
		scaleX: 5,
		scaleY: 5
	});
	pauseContainer.addChild(resumeBtn);
	// Restart button
	var restartBtn = LK.getAsset('restartbutton', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: pauseButtonStartY + pauseButtonHeight + pauseButtonSpacing,
		scaleX: 5,
		scaleY: 5
	});
	pauseContainer.addChild(restartBtn);
	// Main menu button
	var pauseMainMenuBtn = LK.getAsset('mainmenu', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: pauseButtonStartY + 2 * (pauseButtonHeight + pauseButtonSpacing),
		scaleX: 5,
		scaleY: 5
	});
	pauseContainer.addChild(pauseMainMenuBtn);
	// Resume button handler
	resumeBtn.down = function (x, y, obj) {
		LK.getSound('buttonclick').play();
		tween(resumeBtn, {
			scaleX: 4.5,
			scaleY: 4.5
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(resumeBtn, {
					scaleX: 5,
					scaleY: 5
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						resumeGame();
					}
				});
			}
		});
	};
	// Restart button handler
	restartBtn.down = function (x, y, obj) {
		LK.getSound('buttonclick').play();
		tween(restartBtn, {
			scaleX: 4.5,
			scaleY: 4.5
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(restartBtn, {
					scaleX: 5,
					scaleY: 5
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						pauseContainer.visible = false;
						gamePaused = false;
						gameActive = false; // Stop game temporarily during restart
						maxCombo = 0;
						perfectCount = 0;
						maxPerfectCombo = 0;
						// Reset lives and hearts before showing ready screen
						lives = MAX_LIVES;
						heartshields = 3; // Reset heartshields
						// Remove all existing heart icons
						for (var i = 0; i < heartIcons.length; i++) {
							if (heartIcons[i] && heartIcons[i].parent) {
								heartIcons[i].parent.removeChild(heartIcons[i]);
							}
						}
						// Recreate all heart icons as full heartshields
						heartIcons = [];
						var heartY = scoreTxt.y + 50;
						var heartWidth = 150;
						var totalHeartsWidth = MAX_LIVES * heartWidth + (MAX_LIVES - 1) * heartSpacing;
						var heartStartX = 2048 - 100 - totalHeartsWidth;
						for (var i = 0; i < MAX_LIVES; i++) {
							var heartAsset = LK.getAsset('heartshield', {
								anchorX: 0,
								anchorY: 0,
								x: heartStartX + i * (heartWidth + heartSpacing),
								y: heartY
							});
							gamescreen.addChild(heartAsset);
							heartIcons.push(heartAsset);
						}
						showReadyScreen(function () {
							showCountdown(function () {
								startGame();
							});
						});
					}
				});
			}
		});
	};
	// Pause main menu button handler
	pauseMainMenuBtn.down = function (x, y, obj) {
		LK.getSound('buttonclick').play();
		tween(pauseMainMenuBtn, {
			scaleX: 4.5,
			scaleY: 4.5
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(pauseMainMenuBtn, {
					scaleX: 5,
					scaleY: 5
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						pauseContainer.visible = false;
						gamePaused = false;
						gameActive = false;
						maxCombo = 0;
						perfectCount = 0;
						maxPerfectCombo = 0;
						mainMenuContainer.visible = true;
						scoreTxt.visible = false;
						comboTxt.visible = false;
						bpmDisplayTxt.visible = false;
						songNameTxt.visible = false;
						gamescreen.visible = false;
						// Stop current music and play menu music (only if not muted)
						LK.stopMusic();
						if (!musicMuted) {
							LK.setTimeout(function () {
								var volumeMultiplier = soundVolume / 100;
								LK.playMusic('menumusic', {
									volume: 0.8 * volumeMultiplier,
									loop: true
								});
							}, 100);
						}
					}
				});
			}
		});
	};
}
// Resume game function
function resumeGame() {
	gamePaused = false;
	pauseContainer.visible = false;
	// Show BPM and song name when resuming
	bpmDisplayTxt.visible = true;
	songNameTxt.visible = true;
	lastTickTime = Date.now(); // Reset time to prevent time jump
}
// --- Beat spawning ---
function spawnBeat(beat) {
	var marker = new BeatMarker();
	// All beats spawn at left edge of screen (x=0)
	marker.x = 0; // Always spawn at left edge
	marker.y = HIT_ZONE_Y;
	marker.beatTime = beat.time;
	marker.type = beat.type;
	marker.active = true;
	marker.hit = false;
	marker.lastX = marker.x; // initialize lastX for correct miss logic
	marker.hasReachedHitZone = false; // initialize for correct miss logic
	beats.push(marker);
	gamescreen.addChild(marker);
}
// --- Game update ---
game.update = function () {
	if (!gameActive || gamePaused) {
		return;
	}
	// Time management
	var now = Date.now();
	var dt = (now - lastTickTime) / 1000;
	lastTickTime = now;
	songTime += dt;
	// Prevent beat spawning until countdown is finished and gameplay is visible
	if (!gamescreen.visible || countdownContainer.visible) {
		return;
	}
	// Only allow beat spawning after countdown is finished
	if (!countdownContainer.visible) {
		// Spawn new beats with constant speed and BPM-based timing
		var currentBeatSpeed = getBeatSpeed(); // Always 400 px/s
		// Calculate travel time from left edge (x=0) to hit zone
		var travelTime = HIT_ZONE_X / currentBeatSpeed; // Time needed to travel from x=0 to hit zone
		// Spawn beats at the right time so they arrive at hit zone exactly when needed
		while (nextBeatIdx < beatPattern.length && beatPattern[nextBeatIdx].time - songTime <= travelTime) {
			spawnBeat(beatPattern[nextBeatIdx]);
			nextBeatIdx++;
		}
	}
	// Check for BPM progression every 10,000 points
	if (score >= 10000 && score - lastBpmUpgradeScore >= 10000) {
		if (bpm < 120) {
			// Don't increase BPM beyond 120
			lastBpmUpgradeScore = score;
			var oldBpm = bpm;
			bpm = Math.min(120, bpm + 5); // Increase by 5 BPM, cap at 120
			if (bpm !== oldBpm) {
				// Update BPM display
				if (bpmDisplayTxt) {
					bpmDisplayTxt.setText(bpm + ' BPM');
				}
				// Update beat interval for new beats
				beatInterval = 60 / bpm;
				// Get new music ID
				var newMusicId = '100BPMSynthWave'; // Default fallback
				if (bpm === 40) {
					newMusicId = '40BPMDeepVibes';
				} else if (bpm === 45) {
					newMusicId = '45BPMChillWave';
				} else if (bpm === 50) {
					newMusicId = '50BPMSlowMotion';
				} else if (bpm === 55) {
					newMusicId = '55BPMDreamscape';
				} else if (bpm === 60) {
					newMusicId = '60BPMLowKey';
				} else if (bpm === 65) {
					newMusicId = '65BPMRelaxed';
				} else if (bpm === 70) {
					newMusicId = '70BPMCalmVibes';
				} else if (bpm === 75) {
					newMusicId = '75BPMElectricDreams';
				} else if (bpm === 80) {
					newMusicId = '80BPMNeonNights';
				} else if (bpm === 85) {
					newMusicId = '85BPMCyberFlow';
				} else if (bpm === 90) {
					newMusicId = '90BPMDigitalPulse';
				} else if (bpm === 95) {
					newMusicId = '95BPMFutureBass';
				} else if (bpm === 100) {
					newMusicId = '100BPMSynthWave';
				} else if (bpm === 105) {
					newMusicId = '105BPMHyperDrive';
				} else if (bpm === 110) {
					newMusicId = '110BPMTechnoRush';
				} else if (bpm === 115) {
					newMusicId = '115BPMHighEnergy';
				} else if (bpm === 120) {
					newMusicId = '120BPMMaximum';
				}
				// Fade out current music and fade in new music
				var volumeMultiplier = soundVolume / 100;
				LK.stopMusic();
				LK.playMusic(newMusicId, {
					volume: 0,
					loop: true,
					fade: {
						start: 0,
						end: 1 * volumeMultiplier,
						duration: 1000
					}
				});
				// Play scratch sound when BPM changes
				LK.getSound('scratch').play();
				// Update song name display
				if (songNameTxt) {
					var songName = newMusicId.replace(/^\d+BPM/, '');
					songNameTxt.setText(songName);
				}
			}
		}
	}
	// Move beats and check for misses
	for (var i = beats.length - 1; i >= 0; i--) {
		var beat = beats[i];
		// Move beats at constant speed from left to right
		var currentBeatSpeed = getBeatSpeed(); // Always 400 px/s
		// Calculate elapsed time since beat was spawned
		var elapsedTime = songTime - (beat.beatTime - HIT_ZONE_X / currentBeatSpeed);
		// Move beat from left edge at constant speed
		beat.x = elapsedTime * currentBeatSpeed;
		// Ensure beat stays within reasonable bounds
		if (beat.x < -400) {
			beat.x = -400;
		}
		if (beat.x > TIMELINE_X + TIMELINE_WIDTH + 400) {
			beat.x = TIMELINE_X + TIMELINE_WIDTH + 400;
		}
		// Ensure beatMarker always passes below kickTarget
		if (kickTarget && kickTarget.parent) {
			var kickTargetIndex = kickTarget.parent.getChildIndex(kickTarget);
			var beatIndex = beat.parent.getChildIndex(beat);
			if (beatIndex > kickTargetIndex) {
				beat.parent.setChildIndex(beat, kickTargetIndex);
			}
		}
		// Track lastX for miss detection
		if (typeof beat.lastX === "undefined") {
			beat.lastX = beat.x;
		}
		// Only check for miss if the beat has passed the hit zone (not before)
		// Also, do not count as miss if the beat has not yet reached the hit zone at least once
		if (!beat.hit && beat.active && typeof beat.hasReachedHitZone !== "undefined" && beat.hasReachedHitZone && beat.lastX <= HIT_ZONE_X + HIT_WINDOW && beat.x > HIT_ZONE_X + HIT_WINDOW) {
			// Missed
			beat.active = false;
			misses++;
			// Replace the beat marker asset with missCircle for missed beats
			var missedAsset = LK.getAsset('missCircle', {
				anchorX: 0.5,
				anchorY: 0.5,
				x: beat.x,
				// Start from current beat position
				y: beat.y,
				alpha: 0.8,
				width: 60,
				height: 59.77
			});
			// Replace the beat's current asset with missCircle
			if (beat.parent) {
				// Store parent reference before removing beat
				var beatParent = beat.parent;
				// Remove the old beat marker from its parent
				beatParent.removeChild(beat);
				// Add the missed asset to the stored parent reference
				beatParent.addChild(missedAsset);
				// Update the beat reference to point to the new asset
				beats[i] = missedAsset;
				// Copy over important properties
				missedAsset.beatTime = beat.beatTime;
				missedAsset.type = beat.type;
				missedAsset.active = false;
				missedAsset.hit = false;
				missedAsset.lastX = beat.x; // Use current position
				missedAsset.hasReachedHitZone = true;
				missedAsset.isMissed = true; // Mark as missed for special handling
				// Destroy the original beat asset
				beat.destroy();
			}
			// Handle heartshield system
			if (heartshields > 0) {
				// Convert leftmost heartshield to heart (heartshields are lost left to right)
				var shieldIndex = 3 - heartshields; // Get the leftmost heartshield index
				if (heartIcons[shieldIndex]) {
					var parent = heartIcons[shieldIndex].parent;
					if (parent) {
						parent.removeChild(heartIcons[shieldIndex]);
					}
					heartIcons[shieldIndex] = LK.getAsset('heart', {
						anchorX: 0,
						anchorY: 0,
						x: heartStartX + shieldIndex * (heartWidth + heartSpacing),
						y: heartY
					});
					gamescreen.addChild(heartIcons[shieldIndex]);
				}
				heartshields--; // Lose one heartshield
				// No miss feedback, sound, or other penalties for heartshield hits
			} else {
				// All heartshields are gone, now show miss effects and lose hearts
				beat.showFeedback('miss');
				combo = 0;
				perfectCombo = 0; // Reset perfect combo on miss
				// missTxt removed, only hearts for lives
				comboTxt.setText('');
				LK.effects.flashObject(kickTarget, 0xff0000, 200);
				// Play miss sound
				LK.getSound('miss').play();
				// Show MISS feedback text at hit zone
				var missText = new Text2('MISS', {
					size: 20,
					fill: 0xff0000
				});
				missText.scale.set(6, 6);
				missText.anchor.set(0.5, 0.5);
				missText.x = HIT_ZONE_X;
				missText.y = HIT_ZONE_Y - 180;
				game.addChild(missText);
				tween(missText, {
					alpha: 0,
					y: missText.y - 100
				}, {
					duration: 600,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						missText.destroy();
					}
				});
				// Lose a heart and update heart icon (hearts are lost left to right)
				if (lives > 0) {
					var lostIndex = MAX_LIVES - lives; // soldan sağa kaybetmek için
					if (heartIcons[lostIndex]) {
						var parent = heartIcons[lostIndex].parent;
						if (parent) {
							parent.removeChild(heartIcons[lostIndex]);
						}
						heartIcons[lostIndex] = LK.getAsset('lostheart', {
							anchorX: 0,
							anchorY: 0,
							x: heartStartX + lostIndex * (heartWidth + heartSpacing),
							y: heartY
						});
						gamescreen.addChild(heartIcons[lostIndex]);
					}
					lives--;
				}
				if (lives <= 0) {
					gameOver();
				}
			}
		}
		// Track if beat has reached the hit zone at least once
		if (typeof beat.hasReachedHitZone === "undefined") {
			beat.hasReachedHitZone = false;
		}
		if (!beat.hasReachedHitZone && beat.x >= HIT_ZONE_X - HIT_WINDOW) {
			beat.hasReachedHitZone = true;
		}
		// Remove if off screen
		if (beat.x > TIMELINE_X + TIMELINE_WIDTH + 100) {
			beat.destroy();
			beats.splice(i, 1);
		}
		// Update lastX for next frame
		beat.lastX = beat.x;
	}
};
// --- Input handling ---
var isTouching = false;
game.down = function (x, y, obj) {
	if (!gameActive || gamePaused) {
		return;
	}
	// Don't register hits during ready screen
	if (readyContainer.visible) {
		return;
	}
	// Don't register hits when gamescreen is not visible (e.g., in main menu)
	if (!gamescreen.visible) {
		return;
	}
	// Only register if touch is in hit zone
	var dx = x - HIT_ZONE_X;
	var dy = y - HIT_ZONE_Y;
	var dist = Math.sqrt(dx * dx + dy * dy);
	if (dist < 120) {
		isTouching = true;
		// Animate kick target
		kickTarget.destroy();
		kickTarget = LK.getAsset('kickActive', {
			anchorX: 0.5,
			anchorY: 0.5,
			x: HIT_ZONE_X,
			y: HIT_ZONE_Y
		});
		gamescreen.addChild(kickTarget);
		// Check for beat hit
		var hit = false;
		for (var i = 0; i < beats.length; i++) {
			var beat = beats[i];
			if (beat.active && !beat.hit && Math.abs(beat.x - HIT_ZONE_X) < HIT_WINDOW) {
				// Calculate timing accuracy
				var distFromCenter = Math.abs(beat.x - HIT_ZONE_X);
				var feedbackType = '';
				var feedbackText = '';
				var feedbackColor = 0xffffff;
				var scoreAdd = 0;
				if (distFromCenter < 20) {
					feedbackType = 'perfect';
					feedbackText = 'PERFECT!';
					feedbackColor = 0xffe600;
					scoreAdd = 200;
					perfectCount++; // Increment perfect count
					perfectCombo++; // Increment consecutive perfect hits
					if (perfectCombo > maxPerfectCombo) {
						maxPerfectCombo = perfectCombo; // Track maximum consecutive perfect hits
					}
				} else if (distFromCenter < 40) {
					feedbackType = 'awesome';
					feedbackText = 'AWESOME!';
					feedbackColor = 0x00e6ff;
					scoreAdd = 150;
					perfectCombo = 0; // Reset perfect combo for non-perfect hit
				} else if (distFromCenter < 70) {
					feedbackType = 'good';
					feedbackText = 'GOOD';
					feedbackColor = 0x00ff00;
					scoreAdd = 100;
					perfectCombo = 0; // Reset perfect combo for non-perfect hit
				} else {
					feedbackType = 'ok';
					feedbackText = 'OK';
					feedbackColor = 0xcccccc;
					scoreAdd = 50;
					perfectCombo = 0; // Reset perfect combo for non-perfect hit
				}
				beat.hit = true;
				beat.active = false;
				hit = true;
				score += scoreAdd;
				combo += 1;
				if (combo > maxCombo) {
					maxCombo = combo; // Track maximum combo achieved
				}
				LK.setScore(score);
				scoreTxt.setText(score);
				comboTxt.setText('Combo: ' + combo);
				// Show feedback text at hit zone
				var feedbackTxt = new Text2(feedbackText, {
					size: 20,
					fill: feedbackColor
				});
				feedbackTxt.scale.set(6, 6);
				feedbackTxt.anchor.set(0.5, 0.5);
				feedbackTxt.x = HIT_ZONE_X;
				feedbackTxt.y = HIT_ZONE_Y - 180;
				game.addChild(feedbackTxt);
				// Show combo multiplier for perfect hits
				if (feedbackType === 'perfect' && perfectCombo > 1) {
					var comboMultiplierTxt = new Text2('x' + perfectCombo, {
						size: 21,
						fill: 0xff8c00
					});
					comboMultiplierTxt.scale.set(4, 4);
					comboMultiplierTxt.anchor.set(0, 0.5);
					comboMultiplierTxt.x = HIT_ZONE_X + 195;
					comboMultiplierTxt.y = HIT_ZONE_Y - 220;
					game.addChild(comboMultiplierTxt);
					tween(comboMultiplierTxt, {
						alpha: 0,
						y: comboMultiplierTxt.y - 100
					}, {
						duration: 600,
						easing: tween.easeOut,
						onFinish: function onFinish() {
							comboMultiplierTxt.destroy();
						}
					});
				}
				tween(feedbackTxt, {
					alpha: 0,
					y: feedbackTxt.y - 100
				}, {
					duration: 600,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						feedbackTxt.destroy();
					}
				});
				beat.showFeedback('good');
				// Play sounds based on selection - all selected sounds
				if (selectedKickSound !== '') {
					LK.getSound(selectedKickSound).play();
				}
				if (selectedHihatSound !== '') {
					LK.getSound(selectedHihatSound).play();
				}
				if (selectedSnareClapSound !== '') {
					LK.getSound(selectedSnareClapSound).play();
				}
				if (selectedPercussionSound !== '') {
					LK.getSound(selectedPercussionSound).play();
				}
				LK.effects.flashObject(kickTarget, feedbackColor, 200);
				// Replace the beat's current asset based on timing quality while maintaining position and movement
				var newAssetId;
				var tintColor = 0xffffff;
				if (feedbackType === 'perfect') {
					// Perfect hits: perfectcircle asset
					newAssetId = 'perfectcircle';
					tintColor = 0xffffff;
				} else if (feedbackType === 'awesome' || feedbackType === 'good' || feedbackType === 'ok') {
					// Good/awesome/ok hits: green kickActive
					newAssetId = 'kickActive';
					tintColor = 0x00ff00;
				}
				// Replace the beat's visual asset while maintaining its position and movement
				if (beat.parent) {
					// Store parent and current position
					var beatParent = beat.parent;
					var currentX = beat.x;
					var currentY = beat.y;
					// Remove the old beat marker from its parent
					beatParent.removeChild(beat);
					// Create new asset with current position
					var newBeatAsset = LK.getAsset(newAssetId, {
						anchorX: 0.5,
						anchorY: 0.5,
						x: currentX,
						y: currentY,
						tint: tintColor,
						width: 60,
						height: 59.77
					});
					// Add the new asset to the stored parent reference
					beatParent.addChild(newBeatAsset);
					// Update the beat reference to point to the new asset
					beats[i] = newBeatAsset;
					// Copy over important properties
					newBeatAsset.beatTime = beat.beatTime;
					newBeatAsset.type = beat.type;
					newBeatAsset.active = false; // Mark as inactive since it was hit
					newBeatAsset.hit = true;
					newBeatAsset.lastX = currentX;
					newBeatAsset.hasReachedHitZone = true;
					// Destroy the original beat asset
					beat.destroy();
				}
				// BPM remains constant at settings value - no difficulty increase during gameplay
				break;
			}
		}
		if (!hit) {
			// Missed (tapped at wrong time)
			misses++;
			combo = 0;
			perfectCombo = 0; // Reset perfect combo on wrong time
			// missTxt removed, only hearts for lives
			comboTxt.setText('');
			// Play sounds based on selection - all selected sounds
			if (selectedKickSound !== '') {
				LK.getSound(selectedKickSound).play();
			}
			if (selectedHihatSound !== '') {
				LK.getSound(selectedHihatSound).play();
			}
			if (selectedSnareClapSound !== '') {
				LK.getSound(selectedSnareClapSound).play();
			}
			if (selectedPercussionSound !== '') {
				LK.getSound(selectedPercussionSound).play();
			}
			LK.effects.flashObject(kickTarget, 0xff0000, 200);
			// Show WRONG TIME feedback text at hit zone
			var wrongTimeText = new Text2('WRONG TIME', {
				size: 20,
				fill: 0xff4500
			});
			wrongTimeText.scale.set(6, 6);
			wrongTimeText.anchor.set(0.5, 0.5);
			wrongTimeText.x = HIT_ZONE_X;
			wrongTimeText.y = HIT_ZONE_Y - 180;
			game.addChild(wrongTimeText);
			tween(wrongTimeText, {
				alpha: 0,
				y: wrongTimeText.y - 100
			}, {
				duration: 600,
				easing: tween.easeOut,
				onFinish: function onFinish() {
					wrongTimeText.destroy();
				}
			});
			// Only lose a life if countdown is not visible
			if (!countdownContainer.visible) {
				// Handle heartshield system for wrong time hits
				if (heartshields > 0) {
					// Convert leftmost heartshield to heart (heartshields are lost left to right)
					var shieldIndex = 3 - heartshields; // Get the leftmost heartshield index
					if (heartIcons[shieldIndex]) {
						var parent = heartIcons[shieldIndex].parent;
						if (parent) {
							parent.removeChild(heartIcons[shieldIndex]);
						}
						heartIcons[shieldIndex] = LK.getAsset('heart', {
							anchorX: 0,
							anchorY: 0,
							x: heartStartX + shieldIndex * (heartWidth + heartSpacing),
							y: heartY
						});
						gamescreen.addChild(heartIcons[shieldIndex]);
					}
					heartshields--; // Lose one heartshield
					// No miss feedback, sound, or other penalties for heartshield hits
				} else {
					// All heartshields are gone, now lose hearts
					// Lose a life and update heart icon
					if (lives > 0) {
						var lostIndex = MAX_LIVES - lives; // soldan sağa kaybetmek için
						if (heartIcons[lostIndex]) {
							var parent = heartIcons[lostIndex].parent;
							if (parent) {
								parent.removeChild(heartIcons[lostIndex]);
							}
							heartIcons[lostIndex] = LK.getAsset('lostheart', {
								anchorX: 0,
								anchorY: 0,
								x: heartStartX + lostIndex * (heartWidth + heartSpacing),
								y: heartY
							});
							gamescreen.addChild(heartIcons[lostIndex]);
						}
						lives--;
					}
					if (lives <= 0) {
						gameOver();
					}
				}
			}
		}
	}
};
game.up = function (x, y, obj) {
	isTouching = false;
	// Restore kick target
	kickTarget.destroy();
	kickTarget = LK.getAsset('kickTarget', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: HIT_ZONE_X,
		y: HIT_ZONE_Y
	});
	gamescreen.addChild(kickTarget);
};
// --- Game over ---
function gameOver() {
	gameActive = false;
	LK.effects.flashScreen(0xff0000, 800);
	showDefeatScreen();
	LK.stopMusic();
}
// --- Glow Effect for Purple Elements ---
function addGlowEffect(element, glowColor, intensity) {
	if (!element || !element.visible) {
		return;
	}
	// Create glow animation using tint and alpha
	var originalTint = element.tint || 0xffffff;
	var glowTint = glowColor || 0xaa00ff; // Default purple glow
	var glowIntensity = intensity || 0.3;
	// Pulsing glow effect
	function startGlow() {
		tween(element, {
			alpha: 1 - glowIntensity
		}, {
			duration: 800,
			easing: tween.easeInOut,
			yoyo: true,
			repeat: -1 // Infinite repeat
		});
	}
	startGlow();
}
// Apply glow to purple elements
function applyGlowToVioletElements() {
	// Apply glow to kick target (blue/violet color)
	if (kickTarget) {
		addGlowEffect(kickTarget, 0x8a2be2, 0.2);
	}
	// Apply glow to main menu buttons (purple/violet elements)
	if (startBtn) {
		addGlowEffect(startBtn, 0x8a2be2, 0.15);
	}
	if (settingsBtn) {
		addGlowEffect(settingsBtn, 0x8a2be2, 0.15);
	}
	if (creditsBtn) {
		addGlowEffect(creditsBtn, 0x8a2be2, 0.15);
	}
	if (supportBtn) {
		addGlowEffect(supportBtn, 0x8a2be2, 0.15);
	}
	// Apply glow to BPM circle container if it exists
	if (typeof bpmCircleContainer !== 'undefined' && bpmCircleContainer) {
		addGlowEffect(bpmCircleContainer, 0x8a2be2, 0.2);
	}
}
// Initialize glow effects
applyGlowToVioletElements();
// --- Win condition ---
function checkWin() {
	if (score >= 5000) {
		gameActive = false;
		LK.effects.flashScreen(0x00ff00, 800);
		LK.showYouWin();
		LK.stopMusic();
	}
}
// --- Defeat Screen Implementation ---
var defeatContainer = new Container();
defeatContainer.visible = false;
game.addChild(defeatContainer);
var maxCombo = 0; // Track maximum combo achieved
var perfectCount = 0; // Track number of perfect hits
var perfectCombo = 0; // Track current consecutive perfect hits
var maxPerfectCombo = 0; // Track maximum consecutive perfect hits
var lastBpmUpgradeScore = 0; // Track last score where BPM was upgraded
var gamePaused = false; // Track if game is paused
var pauseContainer = new Container();
pauseContainer.visible = false;
game.addChild(pauseContainer);
function showDefeatScreen() {
	defeatContainer.visible = true;
	defeatContainer.removeChildren();
	gamescreen.visible = false;
	bpmDisplayTxt.visible = false;
	songNameTxt.visible = false;
	// Add defeat background using defeatbg asset
	var defeatBg = LK.getAsset('defeatbg', {
		anchorX: 0,
		anchorY: 0,
		x: 0,
		y: 0,
		width: 2048,
		height: 2732
	});
	defeatContainer.addChild(defeatBg);
	// Add blurred background behind statistics
	var blurredBg = LK.getAsset('blurred', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 1235,
		scaleX: 1.35,
		scaleY: 1.35,
		alpha: 1
	});
	defeatContainer.addChild(blurredBg);
	// Game Over title using gameover asset
	var gameOverAsset = LK.getAsset('gameover', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: 600,
		scaleX: 8,
		scaleY: 8
	});
	defeatContainer.addChild(gameOverAsset);
	// Statistics arranged vertically with 5px spacing
	var statsStartY = 990;
	var statsSpacing = 5;
	var currentY = statsStartY;
	// Score display
	var finalScoreTxt = new Text2("Score: " + score, {
		size: 18,
		fill: 0xffffff
	});
	finalScoreTxt.scale.set(6, 6);
	finalScoreTxt.anchor.set(0, 0.5);
	finalScoreTxt.x = 2048 / 2 - 550;
	finalScoreTxt.y = currentY;
	defeatContainer.addChild(finalScoreTxt);
	currentY += finalScoreTxt.height + statsSpacing;
	// Max combo display
	var maxComboTxt = new Text2("Max Combo: " + maxCombo, {
		size: 18,
		fill: 0x00ff00
	});
	maxComboTxt.scale.set(6, 6);
	maxComboTxt.anchor.set(0, 0.5);
	maxComboTxt.x = 2048 / 2 - 550;
	maxComboTxt.y = currentY;
	defeatContainer.addChild(maxComboTxt);
	currentY += maxComboTxt.height + statsSpacing;
	// Perfect count display
	var perfectCountTxt = new Text2("Perfect: " + perfectCount, {
		size: 18,
		fill: 0xffe600
	});
	perfectCountTxt.scale.set(6, 6);
	perfectCountTxt.anchor.set(0, 0.5);
	perfectCountTxt.x = 2048 / 2 - 550;
	perfectCountTxt.y = currentY;
	defeatContainer.addChild(perfectCountTxt);
	currentY += perfectCountTxt.height + statsSpacing;
	// Max perfect combo display (orange color)
	var maxPerfectComboTxt = new Text2("Max Perfect Combo: " + maxPerfectCombo, {
		size: 18,
		fill: 0xff8c00
	});
	maxPerfectComboTxt.scale.set(6, 6);
	maxPerfectComboTxt.anchor.set(0, 0.5);
	maxPerfectComboTxt.x = 2048 / 2 - 550;
	maxPerfectComboTxt.y = currentY;
	defeatContainer.addChild(maxPerfectComboTxt);
	// Calculate button positions
	var defeatButtonStartY = 1700;
	var defeatButtonHeight = 289;
	var defeatButtonSpacing = 20;
	// Tekrar Oyna (Play Again) Button
	var playAgainBtn = LK.getAsset('tryagain', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: defeatButtonStartY,
		scaleX: 5,
		scaleY: 5
	});
	defeatContainer.addChild(playAgainBtn);
	// Ana Menü (Main Menu) Button
	var mainMenuBtn = LK.getAsset('mainmenu', {
		anchorX: 0.5,
		anchorY: 0.5,
		x: 2048 / 2,
		y: defeatButtonStartY + defeatButtonHeight + defeatButtonSpacing,
		scaleX: 5,
		scaleY: 5
	});
	defeatContainer.addChild(mainMenuBtn);
	// Button event handlers
	playAgainBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation
		tween(playAgainBtn, {
			scaleX: 4.5,
			scaleY: 4.5
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(playAgainBtn, {
					scaleX: 5,
					scaleY: 5
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						defeatContainer.visible = false;
						maxCombo = 0; // Reset max combo
						perfectCount = 0; // Reset perfect count
						maxPerfectCombo = 0; // Reset max perfect combo
						showReadyScreen(function () {
							showCountdown(function () {
								startGame();
							});
						});
					}
				});
			}
		});
	};
	mainMenuBtn.down = function (x, y, obj) {
		// Play button click sound
		LK.getSound('buttonclick').play();
		// Click animation
		tween(mainMenuBtn, {
			scaleX: 4.5,
			scaleY: 4.5
		}, {
			duration: 80,
			easing: tween.easeIn,
			onFinish: function onFinish() {
				tween(mainMenuBtn, {
					scaleX: 5,
					scaleY: 5
				}, {
					duration: 120,
					easing: tween.easeOut,
					onFinish: function onFinish() {
						defeatContainer.visible = false;
						maxCombo = 0; // Reset max combo
						perfectCount = 0; // Reset perfect count
						maxPerfectCombo = 0; // Reset max perfect combo
						mainMenuContainer.visible = true;
						scoreTxt.visible = false;
						comboTxt.visible = false;
						bpmDisplayTxt.visible = false;
						songNameTxt.visible = false;
						gamescreen.visible = false;
						// Stop current music and play menu music with a small delay to ensure proper playback (only if not muted)
						LK.stopMusic();
						if (!musicMuted) {
							LK.setTimeout(function () {
								var volumeMultiplier = soundVolume / 100;
								LK.playMusic('menumusic', {
									volume: 0.8 * volumeMultiplier,
									loop: true
								});
							}, 100);
						}
					}
				});
			}
		});
	};
}
// --- Restart on game over ---
LK.on('gameover', function () {
	showDefeatScreen();
});
LK.on('youwin', function () {
	startGame();
});
